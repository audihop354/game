from turtle import width
import pygame
# from pygame.locals import *
import random
import time
import math

pygame.init()

#set color
# green = (76,208,56)
# gray = (100,100,100)
# red = (200,0,0)
# yellow = (255,232,0)
# white = (255,255,255)
color={0:"red", 1:"yellow", 2:"blue", 3:"pink", 4:"green"}

#set screen
WIDTH=1000
HEIGHT=600
screen = pygame.display.set_mode((WIDTH,HEIGHT), pygame.RESIZABLE)

#set caption and icon and image
pygame.display.set_caption("Game cua nha cai den tu Chau Au")
icon = pygame.image.load('img/car.png')
pygame.display.set_icon(icon)
arrow = pygame.image.load('arrow.png')

#Mystery Box
mysbox= pygame.image.load('mics/mystery box.png')
mysbox = pygame.transform.scale(mysbox,(WIDTH/25,HEIGHT/20))
cheetahIcon= pygame.image.load('mics/cheetah.png')
turtleIcon = pygame.image.load('mics/turtle.png')
flipIcon = pygame.image.load('mics/flip.png')
flipIcon = pygame.transform.scale(flipIcon,(screen.get_width()/25,screen.get_height()/20))
itemImg=[]
itemImg.append(cheetahIcon)
itemImg.append(turtleIcon)
itemImg.append(flipIcon)
dizzy_star = []
for i in range(4):
    img_load = pygame.image.load(f"./mics/stun_{i}.png")
    img_load = pygame.transform.scale(img_load,(screen.get_width()/25,screen.get_height()/20))
    dizzy_star.append(img_load)

def resizemysbox(mysbox):
        return pygame.transform.scale(mysbox,(screen.get_width()/25,screen.get_height()/20))
#Background

def rand():
    a=random.randint(0,3)
    b=random.randint(0,3)
    while a==b:
        b=random.randint(0,3)
    return [a,b]
#Note
#0 : Faster
#1 : Slower
#2 : Win
#3 : Flash
#4 : Return to start
#5 : Turn around
#6 : Stun
class ITEM :
    def __init__(self,y,velocity):
        self.img = mysbox
        self.y=y #fixed
        self.appRound=rand()
        self.x= [random.randint(400,700),random.randint(400,700)]
        self.visible=[1,1]
        self.velocity=velocity
        self.duration=0
        self.pivotTime=0 #Set when you pick an item
        self.spriteWin=[]
        self.spriteLose=[]
        self.spriteFlash=[]
        self.curSprite=0
        self.portalX=0
        self.openPortal=0
        self.checkFlip = False
    def slower(self,i):
        self.name = 1
        self.duration=1500
        car[i].velocity=car[i].velocity/1.5
        self.pivotTime=pygame.time.get_ticks()
    def faster(self,i):
        self.name = 0
        self.duration=1000 #Duration of an item
        car[i].velocity=car[i].velocity*1.5
        self.pivotTime= pygame.time.get_ticks()

    def stun(self,i):
        self.duration=800 #Duration of an item
        car[i].velocity = 0
        self.pivotTime = pygame.time.get_ticks()
        self.curSprite = 0
    def runStun(self,i):
        self.name = 3
        if (car[i].velocity == 0):
            self.curSprite += 0.1
        if (self.curSprite<=3):
            draw(dizzy_star[int(self.curSprite)],car[i].x+screen.get_width()/100,car[i].y-screen.get_width()/35)
        else:
            self.curSprite = self.curSprite % 3
    
    def flip(self, i):
        self.name = 2
        self.checkFlip = True
        car[i].velocity = -1 * car[i].velocity
        for j in range(4):
            car[i].img[j] = pygame.transform.flip(car[i].img[j],True,False)
        
        self.duration = 500
        self.pivotTime = pygame.time.get_ticks()

    def backToNormal(self, i): 
        global curTime
        if curTime-self.pivotTime > self.duration:
            car[i].velocity = self.velocity
            if self.checkFlip == True:
                for j in range(4):
                    car[i].img[j] = pygame.transform.flip(car[i].img[j],True,False)
                self.checkFlip = False
            return 0
        return 1

    def win(self,idx):
        self.openPortal=1
        self.portalX=0
        self.out=0
        self.curSprite=0

           
    def runWin(self,idx):
        if isCollide(car[idx].x,car[idx].y,self.portalX,self.y):
            bg[mapSelected][car[idx].curRound].car.remove(idx)
            car[idx].curRound=3
            bg[mapSelected][car[idx].curRound].car.append(idx)
            if self.out==0:
                car[idx].x=screen.get_width()/1.3
                self.curSprite=4
            self.out=1
            self.portalX=screen.get_width()/1.3
        if self.out==0:    
            if self.curSprite>3:
                self.curSprite=0
        else:
            if self.curSprite>7:
                self.curSprite=4
        self.curSprite+=0.4
        if car[idx].curRound==car[carSelected].curRound:
            draw(self.spriteWin[int(self.curSprite)],self.portalX,self.y-30)
        if distance(car[idx].x,car[idx].y,self.portalX,self.y)>140 and self.out :
            self.openPortal=0

    def lose(self,idx):
        self.openPortal=2
        self.portalX=0
        self.out=0
        self.curSprite=0

    def runLose(self,idx):
        if isCollide(car[idx].x,car[idx].y,self.portalX,self.y):
            if self.out==0:
                car[idx].x=10
                self.curSprite=4
            self.out=1
            self.portalX=10
        if self.out==0:    
            if self.curSprite>3:
                self.curSprite=0
        else:
            if self.curSprite>7:
                self.curSprite=4
        self.curSprite+=0.4
        if car[idx].curRound==car[carSelected].curRound:
            draw(self.spriteLose[int(self.curSprite)],self.portalX,self.y-30)
        if distance(car[idx].x,car[idx].y,self.portalX,self.y)>250:
            self.openPortal=0

    def flash(self,idx):
        car[idx].x+=170
        car[idx].y=-100
        self.curSprite=0
        self.flashX= car[idx].x+10
    def runFlash(self,idx):
        if self.curSprite+0.20<5:
            self.curSprite+=0.20
        else:
            car[idx].y=self.y-20
        if car[idx].curRound == car[carSelected].curRound:
            draw(self.spriteFlash[int(self.curSprite)],self.flashX,self.y-30)
            

class BACKGROUND:
    def __init__(self,img, start,end) :
        self.img=pygame.transform.scale(img,(screen.get_width(),screen.get_height()))
        self.start=start
        self.end=end
        self.car=[]

bg=[]
for i in range (1):
    bg.append([])
    for j in range(4):
        start,end=0,screen.get_width()  
        if j==3:
            end =screen.get_width()/1.1
        img=(f"./background levels/background-{i}-{j}.png")
        bg[i].append(BACKGROUND(pygame.image.load(img),start,end))

#Car
class CAR:
    def __init__(self, car_y,ratio ,velocity,curRound):
        self.img = []
        self.x = 0
        self.y = car_y/ratio
        self.velocity = velocity
        self.destination = 0
        self.curRound=curRound
        self.oldWidth = screen.get_width()
        self.ratio=ratio
        self.curSprite=0
    def addImg(self,img):
        self.img.append(pygame.transform.scale(img,(WIDTH/12.5,HEIGHT/12)))
    def run(self):
        self.x += self.velocity 
    def runAnimation(self,ok):
        if self.curSprite>3:
            self.curSprite=0
        if ok:
            self.curSprite+=0.4
        draw(self.img[int(self.curSprite)],self.x,self.y)
    def resize(self):
        w = screen.get_width()
        h = screen.get_height()
        for i in range(4):
            self.img[i] = pygame.transform.scale(self.img[i],(w/12.5,h/12))
        self.velocity = w * self.velocity / self.oldWidth
        self.oldWidth = screen.get_width()
        self.y=h/self.ratio
# Car initialization
transportation={
    0:"formula ones" # List phuong tien
}
transSelected=0
r=[2.28,1.83,1.5,1.27,1.12] # ratio cho vo 1 mang de initialize
car=[]
for i in range (5):
    trans= transportation[transSelected]
    car.append(CAR(HEIGHT,r[i], random.uniform(2.8,3), 0))
    for j in range(4): # Add animation
        img=f"./{transportation[0]}/{j}_{color[i]}.png"
        car[i].addImg(pygame.image.load(img))
# Item initialization
item=[]
for i in range(5):
    item.append(ITEM(car[i].y+int(screen.get_height()/50),car[i].velocity))

for i in range(5):
    for j in range(8):
        img=f"./mics/portal_{j}.png"
        item[i].spriteWin.append(pygame.image.load(img))
    for j in range(5):
        img=f"./mics/flash_{j}.png"
        item[i].spriteFlash.append(pygame.image.load(img))

for i in range(5):
    for j in range(8):
        img=f"./mics/portal_lose_{j}.png"
        item[i].spriteLose.append(pygame.image.load(img))
#function for GAME
def draw(player_car,x,y):
    screen.blit(player_car,(x, y))
def isCollide(a,b,x,y):
    return (math.sqrt((a-x)*(a-x)+(b-y)*(b-y))<80)

def distance(a,b,x,y):
    return math.sqrt((a-x)*(a-x)+(b-y)*(b-y))

frame = 0

#game Loop
clock = pygame.time.Clock()
fps = 120

#Initalize
r=0
carSelected=0
mapSelected=0
pressed=0
winItem=-1

for i in range (5):
    bg[mapSelected][r].car.append(i)
    car[i].x=bg[mapSelected][r].start
    car[i].curRound=r

#System Time
curTime=0
pivotTime=0
checkFlip = False

#GAME
running=True
while running:
    curTime=pygame.time.get_ticks()
    clock.tick(fps)     
    screen.blit(bg[mapSelected][car[carSelected].curRound].img,(0,0))
    #Events
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
            pygame.quit()
            exit()
        if event.type == pygame.KEYDOWN and pressed==0:
            pressed=1
            if event.key==pygame.K_F1:
                carSelected=0
            if event.key==pygame.K_F2:
                carSelected=1
            if event.key==pygame.K_F3:
                carSelected=2
            if event.key==pygame.K_F4:
                carSelected=3
            if event.key==pygame.K_F5:
                carSelected=4
        if event.type == pygame.KEYUP and pressed:
            pressed=0
        #resize screen
        if event.type == pygame.VIDEORESIZE:

            screen = pygame.display.set_mode((event.w, event.h), pygame.RESIZABLE)
            for i in range (4):
                img=(f"./background levels/background-{mapSelected}-{i}.png")
                bg[mapSelected][i].img = pygame.transform.scale(pygame.image.load(img),(screen.get_width(),screen.get_height()))
                bg[mapSelected][i].end = screen.get_width()

            bg[mapSelected][3].end = screen.get_width()/1.1

            for i in range(5):
                car[i].resize()
                item[i].velocity = car[i].velocity
                item[i].y=car[i].y + int(screen.get_height()/50)
                mysbox = resizemysbox(mysbox)


    #draw items
    for i in range(5):
        for j in range (2):
            if item[i].appRound[j] == car[carSelected].curRound and item[i].visible[j]==1:
                draw(mysbox,item[i].x[j],item[i].y)
    #Win
    for i in range (5):
        if item[i].openPortal==1:
            # print (i)
            item[i].runWin(i)
        if item[i].openPortal==2:
            item[i].runLose(i)
    #Flash
    for i in range(5):
        if car[i].y<0 :
            item[i].runFlash(i)
    #runStun
    for i in range(5):
        if car[i].velocity == 0 and car[carSelected].curRound == car[i].curRound:
            item[i].runStun(i)

    #draw 5 car
    for i in bg[mapSelected][car[carSelected].curRound].car:
        if car[i].x <= bg[mapSelected][car[carSelected].curRound].end: # check finished 
            car[i].runAnimation(1)
        else:
            car[i].runAnimation(0)

    #Check collision
    for i in range (5):
        for j in range(2):
            if item[i].appRound[j] == car[i].curRound and isCollide(car[i].x,car[i].y,item[i].x[j],item[i].y) and item[i].visible[j]:
                item[i].visible[j]=0
                picked=random.randint(0,99)
                if picked <= 33:
                    item[i].slower(i)
                elif picked <= 67:
                    item[i].faster(i)
                elif picked <= 76:
                    item[i].flip(i)
                elif picked == 76:
                    item[i].win(i)
                    item[i].portalX=car[i].x+200
                elif picked<=81:
                    item[i].lose(i)
                    item[i].portalX=car[i].x+200
                elif picked<=91 :
                    item[i].flash(i)
                else:
                    item[i].stun(i)
                    item[i].runStun(i)
            # Show the item picked
            if item[i].backToNormal(i) and car[i].curRound==car[carSelected].curRound:
                if (pressed==0 or i!=carSelected) and item[i].name<=2:
                    draw(itemImg[item[i].name],car[i].x+screen.get_width()/100,car[i].y-screen.get_height()/22)
    if pressed ==1:
        for i in bg[mapSelected][car[carSelected].curRound].car:
            if i==carSelected :
                draw(arrow,car[i].x+10,car[i].y-45)
    #check if the car have finish the race
    for i in range (5):
        if car[i].x<=bg[mapSelected][car[i].curRound].end:
            car[i].run()
        elif car[i].curRound<3: 

            bg[mapSelected][car[i].curRound].car.remove(i)
            car[i].curRound+=1
            bg[mapSelected][car[i].curRound].car.append(i)
            car[i].x=bg[mapSelected][car[i].curRound].start-(screen.get_width()/10)
        # else: 
        #     if item[i].openPortalWin:
        #         item[i].openPortalWin=0
                
    pygame.display.update()
pygame.quit()